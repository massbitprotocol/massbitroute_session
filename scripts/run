#!/bin/bash
TYPE="session"
SITE_ROOT=$(realpath $(dirname $(realpath $0))/..)
export HOME=$SITE_ROOT

bash $SITE_ROOT/cmd_server _env
source $SITE_ROOT/.env_raw

source $SITE_ROOT/scripts/base.sh
cd $SITE_ROOT
# _load_env $SITE_ROOT

REPOS="/etc/letsencrypt|$GIT_PRIVATE_READ_URL/massbitroute/ssl.git|master \
/massbit/massbitroute/app/gbc|$GIT_PUBLIC_URL/massbitprotocol/massbitroute_gbc.git \
$SITE_ROOT|$GIT_PUBLIC_URL/massbitprotocol/massbitroute_${TYPE}.git \
$SITE_ROOT/etc/mkagent|$GIT_PUBLIC_URL/massbitprotocol/massbitroute_mkagent.git"
_prepare() {
	echo "Prepare"
}

_install() {
	mkdir -p $SITE_ROOT/logs $SITE_ROOT/db
	_git_config
	for _pathgit in $REPOS; do
		_path=$(echo $_pathgit | cut -d'|' -f1)
		_url=$(echo $_pathgit | cut -d'|' -f2)
		_branch=$(echo $_pathgit | cut -d'|' -f3)
		_git_clone $_url $_path $_branch
	done

	ln -sf /massbit/massbitroute/app/gbc /massbit/massbitroute/app/src/gbc
	ln -sf /massbit/massbitroute/app/gbc/bin/openresty /usr/local/openresty
	apt-get update
	apt-get install -y git apache2-utils supervisor jq python-is-python2 libssl-dev

	systemctl enable supervisor
	systemctl start supervisor

	mkdir -p /etc/supervisor/conf.d
	cp supervisor.conf /etc/supervisor/conf.d/${TYPE}.conf
	supervisorctl update
}

_reload() {
	bash $SITE_ROOT/etc/mkagent/push.sh _kill
	$SITE_ROOT/cmd_server _update
}

_update() {
	echo "Update"
	st=0
	return $st
}

_monitor() {
	echo mbr-session >vars/TYPE
	_update_sources $REPOS
	is_reload=$?

	_update
	if [ $is_reload -ne 0 ]; then
		is_reload=$?
	fi

	if [ $is_reload -ne 0 ]; then
		$0 _reload
	fi
}
_run() {
	rm -rf $SITE_ROOT/tmp/*
	$SITE_ROOT/start_server
}

$@
